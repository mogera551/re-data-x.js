(()=>{"use strict";class e{target;thisArg;args;constructor(e,t,s){this.target=e,this.thisArg=t,this.args=s}async exec(e=this.target,t=this.thisArg,s=this.args){return await Reflect.apply(e,t,s)}}class t{queue=[];enqueue(e,t=this.queue){t.push(e)}async exec(e=this.queue){for(;;){const t=e.slice();if(0===t.length)break;e.splice(0);for(const e of t)await e.exec()}}}const s=class{static getPath(e,t){let s=0;return e.replaceAll("*",(()=>t[s++]??"*"))}static raise(e){throw e}static isFunction=e=>{const t=Object.prototype.toString.call(e).slice(8,-1).toLowerCase();return"function"===t||"asyncfunction"===t};static isSymbol=e=>"symbol"==typeof e;static toElement=e=>e instanceof HTMLElement?e:this.raise(`node ${e} is not HTMLElement`);static toTemplate=e=>e instanceof HTMLTemplateElement?e:this.raise(`node ${e} is not HTMLTemplateElement`);static toInput=e=>e instanceof HTMLInputElement?e:this.raise(`node ${e} is not HTMLInputElement`);static toKebabCase=e=>e.replaceAll(/([A-Z])/g,((e,t,s)=>(s>0?"-":"")+t.toLowerCase()))};class i{component;prop;indexes;path;key;constructor(e,t,i){const o=i??[];this.component=e,this.prop=t,this.indexes=o,this.path=s.getPath(t,o),this.indexesKey=this.indexes.join("\t"),this.key=`${this.prop}\t${this.indexesKey}`}}class o{name;paths=[];level;regexp;constructor(e){this.name=e,this.paths=e.split("."),this.last=this.paths[this.paths.length-1]??null,this.level=e.match(/\*/g)?.length??0,this.regexp=this.level>0?new RegExp("^"+e.replaceAll("*","(\\w+)").replaceAll(".","\\.")+"$"):null,this.closestListName=null,this.listPaths=[this.paths];for(let e=1;e<this.paths.length;e++)this.listPaths.push(this.paths.slice(0,-e));for(let e=0;e<this.paths.length;e++){const t=this.listPaths[e];"*"===t[t.length-1]&&null===this.closestListName&&(this.closestListName=t.slice(0,-1).join("."))}this.listParentPaths=[];for(let e=1;e<this.paths.length;e++)this.listParentPaths.push(this.paths.slice(0,-e));this.parentPathsByPath=new Map,this.setOfParentPath=new Set,this.setOfExpandPath=new Set,this.listParentPaths.forEach((e=>{const t=e.join(".");if(this.setOfParentPath.add(t),"*"===t.at(-1)){const e=t.slice(0,-2);this.setOfExpandPath.add(e)}this.parentPathsByPath.set(t,e)})),this.parentPaths=this.listParentPaths[0]??[],this.parentPath=this.parentPaths.join("."),this.isPrimitive=0===this.parentPaths.length,this.isParentPrimitive=1===this.parentPaths.length,this.privateName=this.isPrimitive?"__"+e:null,this.isExpandable=this.level>0,this.isObjective=!this.isExpandable&&this.paths.length>0,this.isVariable=this.level>0,this.isGlobal=this.name.startsWith("$$"),this.isContext=!this.isGlobal&&"$"===this.name[0]}getNameByIndexes(e){return s.getPath(this.name,e)}compare(e){if(this===e)return 0;const t=this.level-e.level;if(0!==t)return t;const s=this.paths.length-e.paths.length;if(0!==s)return s;for(let t=0;t<this.paths.length;t++)if(this.paths[t]!==e.paths[t])return this.paths[t]<e.paths[t]?-1:1;return 0}static cacheDefinedPropertyByName=new Map;static create(e){if(this.cacheDefinedPropertyByName.has(e))return this.cacheDefinedPropertyByName.get(e);{const t=new o(e);return this.cacheDefinedPropertyByName.set(e,t),t}}}class n{node;props;proc;constructor(e,t,s){this.node=e,this.props=t,this.proc=s}}class r{queue=[];enqueue(e,t=this.queue){t.push(e)}static reorder(e){const t=e.slice();return t.sort(((e,t)=>e.node instanceof HTMLSelectElement&&1===e.props.length&&"value"===e.props[0]?1:-1)),t}exec(e=this.queue){for(;;){const t=e.slice();if(0===t.length)break;e.splice(0);const s=r.reorder(t);for(const e of s)e.proc()}}}class a{asyncProc=new t;notify=new class{queue=[];component;constructor(e){this.component=e}enqueue(e,t=this.queue){e.component.isInitializing||t.push(e)}updateElements(e=this.queue){for(;;){const t=e.slice();if(0===t.length)break;e.splice(0);const s=new Map;t.forEach((e=>{s.has(e.component)||s.set(e.component,[]),s.get(e.component).push(e)}));for(let[e,t]of s.entries()){e?.updateActiveProperty();const s=e?.viewModelProxy,n=t=>{const n=s?.$setOfArrayProps??new Set,r=s?.$setOfRelativePropsByProp??new Set,a=new Set;for(const e of t){if(!n.has(e.prop))continue;const s=r[e.prop]??new Set;for(const e of t)s.has(e.prop)&&a.add(e)}t=t.filter((e=>!a.has(e)));const c=[];("$onNotify"in s??1)&&c.push(...Array.from(t).flatMap((e=>s.$onNotify(e))).filter((e=>null!=e)).flatMap((t=>{const s=o.create(t.prop);return t.indexes.length<s.level?(e.activeProperties.search(t.prop,t.indexes)??[]).map((t=>new i(e,t.name,t.indexes))):new i(e,t.prop,t.indexes)})));for(const s of t){let t=new Set;if(n.has(s.prop)){const e=`${s.prop}.*.`;r.get(s.prop)?.forEach((s=>!s.startsWith(e)&&t.add(s)))}else t=r.get(s.prop)??new Set;c.push(...Array.from(t).flatMap((t=>{const n=o.create(t);return s.indexes.length<n.level?(e.activeProperties.search(t,s.indexes)??[]).map((t=>new i(e,t.name,t.indexes))):new i(e,t,s?.indexes)})))}return c},r=[t];let a=t;for(;;){const e=n(a);if(0===e.length)break;r.push(e),a=e}const c=r.flatMap((e=>e)),l=new Map;c.reduce(((e,t)=>e.set(t.path,t)),l);const p=new Set(l.keys());s.$deleteCache(p),e.binder.updateForNotify(p,new Set),("$onChange"in s??1)&&s.$asyncProc((async()=>{await s.$onChange(Array.from(l.values()))}))}}}};updateNodeScheduler=new r;constructor(){}enqueueAsyncProc(e){this.asyncProc.enqueue(e)}enqueueNotify(e){this.notify.enqueue(e)}enqueueUpdateNode(e){this.updateNodeScheduler.enqueue(e)}async exec(){for(;await this.asyncProc.exec(),this.notify.updateElements(),this.updateNodeScheduler.exec(),0!=this.asyncProc.queue.length||0!=this.notify.queue.length||0!=this.updateNodeScheduler.queue.length;);}}class c{resolve;reject;updator;component;constructor(e=null){this.component=e,this.main()}wakeup(e){this.resolve(e)}stop(){this.reject()}sleep(){return new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}async main(){for(;;)try{this.updator=await this.sleep();try{await this.updator.exec()}finally{this.updator=null}}catch(e){if(void 0!==e&&(console.error(e),!confirm("致命的エラーが発生しました。継続しますか？")))break}}asyncProc(t,s,i){const o=this.updator??new a;o.enqueueAsyncProc(new e(t,s,i)),this.updator||this.wakeup(o)}notify(e,t,s){const o=this.updator??new a;o.enqueueNotify(new i(e,t,s)),this.updator||this.wakeup(o)}updateNode(e,t,s){const i=this.updator??new a;i.enqueueUpdateNode(new n(e,t,s)),this.updator||this.wakeup(i)}static queue=[new c];static get current(){return this.queue.at(-1)}static suspend(e){this.queue.push(new c(e))}static resume(){this.queue.pop().stop()}}class l{definedProp;name;path;indexes;indexesString;indexesStrings;parentPath;constructor(e,t,i,o,n){this.definedProp=e,this.name=e.name,this.path=t,this.indexes=i,this.indexesString=o,this.key=n,this.indexesStrings=Array(i.length);for(let e=0;e<i.length;e++)this.indexesStrings[e]=i.slice(0,e+1).toString();this.parentPath=s.getPath(e.parentPath,i)}compare(e){const t=this.definedProp.compare(e.definedProp);if(0!==t)return t;for(let t=0;t<this.indexes.length;t++){const s=this.indexes[t]-e.indexes[t];if(0!==s)return s}return 0}static cacheActivePropertyByKey=new Map;static cacheActivePropertyByPath=new Map;static create(e,t=[]){const i=t.toString(),n=e+"\t"+i;if(this.cacheActivePropertyByKey.has(n))return this.cacheActivePropertyByKey.get(n);{const r=s.getPath(e,t),a=o.create(e),c=new l(a,r,t,i,n);return this.cacheActivePropertyByKey.set(n,c),this.cacheActivePropertyByPath.set(r,c),c}}static getByPath(e){return this.cacheActivePropertyByPath.get(e)}static getValue(e,t){return e.$getValue(t)}static setValue(e,t,s){return e.$setValue(t,s),!0}}class p{point=0;last=0;name;results=0;constructor(e,t){this.name=e,this.point=0,this.last=performance.now(),this.results=t}check(){this.point++;const e=performance.now(),t=e-this.last;this.results.has(this.point)?this.results.set(this.point,this.results.get(this.point)+t):this.results.set(this.point,t),this.last=e}static resultsByName=new Map;static create(e){let t=this.resultsByName.get(e);return null==t&&(new Map,this.resultsByName.set(e,t)),new p(e,t)}}class h{static localeString=(e,t)=>null!=e?Number(e).toLocaleString():"";static fixed=(e,t)=>e?.toFixed(t[0]??0)??"";static styleDisplay=(e,t)=>e?t[0]??"":"none";static truthy=(e,t)=>!!e;static falsey=(e,t)=>!e;static not=this.falsey;static upperCase=(e,t)=>e?.toUpperCase()??"";static lowerCase=(e,t)=>e?.toLowerCase()??"";static eq=(e,t)=>e==t[0];static ne=(e,t)=>e!=t[0];static lt=(e,t)=>Number(e)<Number(t[0]);static le=(e,t)=>Number(e)<=Number(t[0]);static gt=(e,t)=>Number(e)>Number(t[0]);static ge=(e,t)=>Number(e)>=Number(t[0]);static embed=(e,t)=>decodeURI((t[0]??"").replaceAll("%s",e));static ifText=(e,t)=>e?t[0]??"":t[1]??"";static null=(e,t)=>null==e}class d{}class u{static applyForInput=(e,t)=>t.reduceRight(((e,t)=>t.name in d?d[t.name](e,t.options):e),e);static applyForOutput=(e,t)=>t.reduce(((e,t)=>t.name in h?h[t.name](e,t.options):e),e)}class m extends FileReader{constructor(){super()}#e(e,t){return new Promise(((s,i)=>{super.addEventListener("load",(({target:e})=>s(e.result))),super.addEventListener("error",(({target:e})=>i(e.error))),super[t](e)}))}readAsArrayBuffer(e){return this.#e(e,"readAsArrayBuffer")}readAsDataURL(e){return this.#e(e,"readAsDataURL")}readAsText(e){return this.#e(e,"readAsText")}}class f{static param1(e,t,s,i,o){l.setValue(s,i,u.applyForInput(e[t.name],o))}static param2(e,t,s,i,o){l.setValue(s,i,u.applyForInput(e[t.paths[0]][t.paths[1]],o))}static className(e,t,s,i,o){}static radio(e,t,i,o,n){const r=s.toElement(e);r.checked&&l.setValue(i,o,u.applyForInput(r.value,n))}static checkbox(e,t,i,o,n){const r=s.toElement(e),a=l.getValue(i,o),c=u.applyForInput(r.value,n);if(r.checked)a.push(c);else{const e=a.findIndex((e=>e==c));e>=0&&a.splice(e,1)}}static async file(e,t,i,o,n){const r=s.toInput(e);if(0==r.files.length)return;const a=new m,c=await a.readAsText(r.files[0]),p=u.applyForInput(c,n);l.setValue(i,o,p)}}class y{static param1(e,t,s,i,o){const n=l.getValue(e,t),r=u.applyForOutput(n,o);c.current.updateNode(s,[i],(()=>{s[i.name]=r}))}static param2(e,t,s,i,o){const n=u.applyForOutput(l.getValue(e,t),o);c.current.updateNode(s,i.paths,(()=>{s[i.paths[0]][i.paths[1]]=n}))}static className(e,t,i,o,n){const r=s.toElement(i),a=u.applyForOutput(l.getValue(e,t),n);c.current.updateNode(i,["classList"],(()=>{a?r.classList.add(o.paths[1]):r.classList.remove(o.paths[1])}))}static radio(e,t,i,o,n){const r=s.toElement(i),a=u.applyForOutput(l.getValue(e,t),n);c.current.updateNode(i,["checked"],(()=>{r.checked=r.value==a}))}static checkbox(e,t,i,o,n){const r=s.toElement(i),a=u.applyForOutput(l.getValue(e,t),n);c.current.updateNode(i,["checked"],(()=>{r.checked=!!a.find((e=>e==r.value))}))}static file(e,t,s,i,o){}}const P={param1:[f.param1,y.param1],param2:[f.param2,y.param2],className:[f.className,y.className],radio:[f.radio,y.radio],checkbox:[f.checkbox,y.checkbox],file:[f.file,y.file]};class g{name;paths;updateViewModelFunc;updateNodeFunc;constructor(e){this.name=e,this.paths=e.split(".");const[t,s]=2===this.paths.length&&"class"===this.paths[0]?P.className:"radio"===e||"checkbox"===e||"file"===e?P[e]:1===this.paths.length||2===this.paths.length?P["param"+this.paths.length]:console.error(`unknown property name ${e}`);Object.assign(this,{updateViewModelFunc:t,updateNodeFunc:s})}static cacheNodePropertyByName=new Map;static create(e){let t;return this.cacheNodePropertyByName.has(e)?t=this.cacheNodePropertyByName.get(e):(t=new g(e),this.cacheNodePropertyByName.set(e,t)),t}}class w{viewModelIndexes;parentComponent;node;viewModelPropInfoByNodeProperty=new Map;nodePropertiesByViewModelPath=new Map;get viewModelProxy(){return this.parentComponent?.viewModelProxy??null}get viewModel(){return this.parentComponent?.viewModel??null}constructor(e,t,s){this.node=e,this.parentComponent=t,this.viewModelIndexes=s}bindProperty(e,t,s){const i=l.create(t,this.viewModelIndexes),o=g.create(e);this.viewModelPropInfoByNodeProperty.set(o,{viewModelProperty:i,filters:s});const[n,r]=[this.nodePropertiesByViewModelPath,i.path];return n.has(r)?n.get(r).push(o):n.set(r,[o]),{viewModelProperty:i,nodeProperty:o,filters:s}}assignNodeValue(e,t,s){return Reflect.apply(e.updateNodeFunc,this,[this.viewModelProxy,t,this.node,e,s])}bind(){}updateForNotify(e,t){for(const[s,i]of this.nodePropertiesByViewModelPath.entries())(e.has(s)||t.has(s))&&i.forEach((e=>{const{viewModelProperty:t,filters:s}=this.viewModelPropInfoByNodeProperty.get(e);return this.assignNodeValue(e,t,s)}))}changeViewModelIndexes(e){this.viewModelIndexes.toString()!==e.toString()&&(this.viewModelIndexes=e,Array.from(this.viewModelPropInfoByNodeProperty.values()).forEach((t=>{const s=t.viewModelProperty;t.viewModelProperty=l.create(t.viewModelProperty.name,e);const i=this.nodePropertiesByViewModelPath.get(s.path)??null;null!==i&&(this.nodePropertiesByViewModelPath.delete(s.path),this.nodePropertiesByViewModelPath.set(t.viewModelProperty.path,i))})))}reuseLastValue(e){this.changeViewModelIndexes(e);for(const[e,t]of this.nodePropertiesByViewModelPath.entries())null==t&&console.log(this,this.nodePropertiesByViewModelPath),t.forEach((e=>{const{viewModelProperty:t,filters:s}=this.viewModelPropInfoByNodeProperty.get(e);this.assignNodeValue(e,t,s)}))}}const v=class{static cache=new Map;static trim=e=>e.trim();static has=e=>e.length>0;static parseFilter=e=>{const[t,...s]=e.split(",").map(this.trim);return Object.assign(new class{name;options},{name:t,options:s})};static parseViewModelProp=e=>{const[t,...s]=e.split("|").map(this.trim);return[t,s.map((e=>this.parseFilter(e)))]};static parseBind=(e,t)=>{const[s,i]=[t].concat(...e.split(":").map(this.trim)).splice(-2),[o,n]=this.parseViewModelProp(i);return[s,o,n]};static parseBinds=(e,t)=>{const s=`${e}\t${t}`;if(this.cache.has(s))return this.cache.get(s);{const i=e.split(";").map(this.trim).filter(this.has).map((e=>this.parseBind(e,"$"))).map((([e,s,i])=>(s="@"===s?e:s,[e="$"===e?t:e,s,i])));return this.cache.set(s,i),i}}};class x extends w{component;constructor(e,t,i){super(e,t,i),this.component=this.node instanceof ee?this.node:s.raise(`node ${this.node} is not Component`)}bind(e={}){const t="dialog"in this.component.dataset,s=t?Object.keys(e).map((e=>`${e}:${e};`)).join(""):this.component.dataset.bind??"";v.parseBinds(s,"textContent").forEach((([s,i,o])=>{const{viewModelProperty:n}=this.bindProperty(s,i,o);t?Object.defineProperty(this.component.viewModel,s,{get:()=>Reflect.get(e,n.name),set:t=>Reflect.set(e,n.name,t)}):this.viewModelProxy?(this.component.viewModelProxy.$addImportProp(s),Object.defineProperty(this.component.viewModel,s,{get:()=>l.getValue(this.viewModelProxy,n),set:e=>l.setValue(this.viewModelProxy,n,e)})):Object.defineProperty(this.component.viewModel,s,{get:()=>Reflect.get(O,n.name),set:e=>Reflect.set(O,n.name,e)}),c.current.notify(this.component,s,[])}))}updateForNotify(e,t){for(const[s,i]of this.nodePropertiesByViewModelPath.entries())(e.has(s)||t.has(s))&&i.forEach((e=>{const{viewModelProperty:t,filters:s}=this.viewModelPropInfoByNodeProperty.get(e);c.current.notify(this.component,e.name,[])}))}}class b extends w{element;defaultProperty;constructor(e,t,i){super(e,t,i),this.element=s.toElement(this.node),this.element instanceof HTMLSelectElement||this.element instanceof HTMLTextAreaElement||this.element instanceof HTMLOptionElement?this.defaultProperty="value":this.element instanceof HTMLInputElement?this.defaultProperty="radio"===this.element.type||"checkbox"===this.element.type?"checked":"value":this.defaultProperty="textContent"}bind(){const e=this.element.dataset.bind??"";let t=null;if(!(v.parseBinds(e,this.defaultProperty).map((([e,s,i])=>{if(e.startsWith("on"))this.bindEventHandler(e,s);else{const{nodeProperty:o,viewModelProperty:n}=this.bindProperty(e,s,i);("radio"===e||"checkbox"===e||"file"===e||this.defaultProperty===e)&&(t=o),this.assignNodeValue(o,n,i)}return"oninput"===e})).filter((e=>e)).length>0)&&"textContent"!==this.defaultProperty&&null!=t){const e=t;this.viewModelPropInfoByNodeProperty.has(e)&&this.element.addEventListener("input",(t=>{t.stopPropagation(),c.current.asyncProc((()=>{const{viewModelProperty:t,filters:s}=this.viewModelPropInfoByNodeProperty.get(e);return Reflect.apply(e.updateViewModelFunc,this,[this.node,e,this.viewModelProxy,t,s])}),this,[])}))}}bindEventHandler(e,t){const s=e.slice(2);this.element.addEventListener(s,(e=>{e.stopPropagation(),c.current.asyncProc((()=>this.parentComponent.stackIndexes.push(this.viewModelIndexes,(()=>Reflect.apply(this.viewModelProxy[t],this.viewModelProxy,[e,...this.viewModelIndexes])))),this,[])}))}}class M extends w{bind(){const e=this.node,t=e.textContent.slice(2);this.node=document.createTextNode(""),e.parentNode.replaceChild(this.node,e),v.parseBinds(t??"","textContent").forEach((([e,t,s])=>{const{nodeProperty:i,viewModelProperty:o}=this.bindProperty(e,t,s);this.assignNodeValue(i,o,s)}))}}function N(e,t){const s=e.parentElement;if(s){const e=s.cloneNode();s.replaceWith(e);try{t()}finally{e.replaceWith(s)}}else t()}class B{nodes=[];value;boundNodes=[];root;key;removeNodes(){this.nodes.forEach((e=>e.parentNode&&e.parentNode.removeChild(e)))}updateForNotify(e,t){this.boundNodes.forEach((s=>s.updateForNotify(e,t)))}}class $ extends w{template;constructor(e,t,i){super(e,t,i),this.template=s.toTemplate(this.node)}viewModelProperty;loopChildren=[];expandLoop(e,t=new Map){this.loopChildren.push(...Object.entries(e).map((([e,s])=>{let i;const o=0===this.viewModelProperty.definedProp.level?[e]:this.viewModelProperty.indexes.concat(e);if(t.has(s)){const n=t.get(s);i=n.shift(),i.root=document.createDocumentFragment(),i.nodes.forEach((e=>i.root.appendChild(e))),0===n.length&&t.delete(s),i.boundNodes.forEach((e=>e.reuseLastValue(o))),i.key=e}else i=new B,i.root=document.importNode(this.template.content,!0),i.boundNodes=I.select(this.parentComponent,i.root,this.template,o),i.nodes=Array.from(i.root.childNodes),i.key=e,i.value=s;return i})));const s=document.createDocumentFragment();this.loopChildren.forEach((e=>s.appendChild(e.root))),this.template.after(s)}reexpandLoop(){const e=l.getValue(this.viewModelProxy,this.viewModelProperty),t=new Map;e.length>0&&this.loopChildren.forEach((e=>t.has(e.value)?t.get(e.value).push(e):t.set(e.value,[e]))),this.loopChildren.forEach((e=>e.removeNodes())),this.loopChildren=[],this.expandLoop(e,t)}bind(){const e=this.template.dataset.bind??"";this.viewModelProperty=l.create(e,this.viewModelIndexes);const t=l.getValue(this.viewModelProxy,this.viewModelProperty);N(this.template,(()=>{this.expandLoop(t)}))}updateForNotify(e,t){e.has(this.viewModelProperty.path)?N(this.template,(()=>{this.reexpandLoop()})):this.loopChildren.forEach((s=>s.updateForNotify(e,t)))}reuseLastValue(e){this.changeViewModelIndexes(e),N(this.template,(()=>{this.reexpandLoop()}))}}class k{static create(e,t,i){return t instanceof ee?new x(t,e,i):t instanceof HTMLTemplateElement?new $(t,e,i):t instanceof HTMLElement?new b(t,e,i):t instanceof Comment?new M(t,e,i):void s.raise(`unknown node ${t}`)}}const C=e=>{const t=[];for(;null!=e.parentNode;)t.unshift(Array.from(e.parentNode.childNodes).indexOf(e)),e=e.parentNode;return t};class I{static listOfRouteIndexesByTemplate=new Map;static select(e,t,s,i=[]){const o=[];if(this.listOfRouteIndexesByTemplate.has(s)){const n=this.listOfRouteIndexesByTemplate.get(s).map((e=>e.reduce(((e,t)=>e.childNodes[t]),t)));o.push(...n.map((t=>k.create(e,t,i))))}else{const n=[],r=[],a=Array.from(t.querySelectorAll("[data-bind]"));r.push(...a.map((e=>C(e))));const c=[],l=e=>e.childNodes.forEach((e=>{e instanceof Comment&&"@"===e.textContent[0]&&"@"===e.textContent[1]&&c.push(e),l(e)}));l(t),r.push(...c.map((e=>C(e)))),this.listOfRouteIndexesByTemplate.set(s,r),n.push(...a),n.push(...c),o.push(...n.map((t=>k.create(e,t,i))))}return o.forEach((e=>e.bind())),o}}const E=e=>e instanceof $?e:s.raise(`${e} is not BoundTemplate`);class A{boundNodes=[];component;constructor(e){this.component=e}add(e){this.boundNodes.push(e)}bind(e){this.boundNodes.push(...I.select(this.component,e,this.component.template))}updateForNotify(e,t){this.boundNodes.forEach(((e,t)=>s=>s.updateForNotify(e,t))(e,t))}async walk(e){const t=async s=>{for(const i of s)if(await e(i),i instanceof $){const e=E(i);for(const s of e.loopChildren)await t(s.boundNodes)}};await t(this.boundNodes)}async findNode(e,t){await this.walk((async s=>{const i=Array.from(s.nodePropertiesByViewModelPath.keys());for(const o of i.filter((t=>e.has(t))))await t(o,s.node)}))}static rootBinder=new A(null)}const O=new Proxy({},new class{set(e,t,s,i){return Reflect.set(e,t,s,i),A.rootBinder.updateForNotify(new Set([t]),new Set([`$$${t}`])),!0}}),R=e=>t=>()=>{const s=e.viewModelProxy;return Reflect.apply(t,s,[])},L=e=>t=>s=>{const i=e.viewModelProxy;return Reflect.apply(t,i,[s])},V=class{static build(e,t=e.viewModel){const i=new Map,n=new Set(Object.keys(t).filter((e=>e.startsWith("__")))),r=new Set(Object.keys(t).filter((e=>"$"===e[0]&&"$"!==e[1]))),a=new Set(Object.keys(t).filter((e=>e.startsWith("$$")))),c=[],l=(s,r=null)=>{if(a.has(s))i.set(s,(e=>({get:()=>(e=>()=>{const t=e.slice(2);return O?.[t]})(e)(),set:t=>(e=>t=>{const s=e.slice(2);return O[s]=t,!0})(e)(t),enumerable:!0,configurable:!0}))(s));else{const a=o.create(s);a.isPrimitive?(i.set(s,((e,t)=>({get:()=>((e,t)=>()=>{const s=e.viewModelProxy,i=e.viewModel;return Reflect.get(i,"__"+t,s)})(e,t)(),set:s=>((e,t)=>s=>{const i=e.viewModelProxy,o=e.viewModel;return Reflect.set(o,"__"+t,s,i),!0})(e,t)(s),enumerable:!0,configurable:!0}))(e,s)),n.has(a.privateName)||(Object.defineProperty(t,a.privateName,(e=>({value:e,writable:!0,enumerable:!1,configurable:!0}))(r)),n.add(a.privateName))):i.set(s,((e,t)=>{const{parentPath:s,last:i,level:o}=t;return{get:()=>((e,t,s,i)=>()=>{const o=e.viewModelProxy,n=e.viewModel,r="*"===s?e.stackIndexes.current[i-1]:s;let a;return a=0===i?o[t]?.[r]:Reflect.get(n,t,o)?.[r],a})(e,s,i,o)(),set:t=>((e,t,s,i)=>o=>{const n=e.viewModelProxy,r=e.viewModel,a="*"===s?e.stackIndexes.current[i-1]:s;return 0===i?n[t][a]=o:Reflect.get(r,t,n)[a]=o,!0})(e,s,i,o)(t),enumerable:!0,configurable:!0}})(e,a))}};for(const[e,s]of Object.entries(t))n.has(e)||r.has(e)||(s!==Symbol.for("import")?l(e,s):c.push(e));for(const[o,n]of Object.entries(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(t)))){if("constructor"===o)continue;if(s.isFunction(n.value))continue;i.has(o)||l(o);const t=i.get(o);n.get&&(t.get=()=>R(e)(n.get)()),n.set&&(t.set=t=>L(e)(n.set)(t))}Object.keys(t).filter((e=>!n.has(e)&&!r.has(e))).forEach((e=>delete t[e])),Array.from(i.entries()).forEach((([e,s])=>Object.defineProperty(t,e,s)));const p=Object.keys(t).concat(c),h=p.map((e=>o.create(e))).sort(((e,t)=>e.level===t.level?e.paths.length-t.paths.length:e.level-t.level)),d=p.filter((e=>`${e}.*`in t)),u=new Map;return h.reduce(((e,t)=>(e.set(t.name,new Set(h.filter((e=>e.setOfParentPath.has(t.name))).map((e=>e.name)))),e)),u),{importProps:c,arrayProps:d,setOfRelativePropsByProp:u,definedProperties:h}}},F=Symbol.for("raw"),S=Symbol.for("isProxy"),D=new Set(["$getValue","$setValue","$init","$deleteCache","$asyncProc","$notify","$openDialog","$closeDialog","$cancelDialog","$addImportProp","$findNode"]),j=new Map;j.set("$indexes",(e=>e.component.stackIndexes.current)),j.set("$component",(e=>e.component)),j.set("$setOfImportProps",(e=>e.setOfImportProps)),j.set("$setOfArrayProps",(e=>e.setOfArrayProps)),j.set("$setOfRelativePropsByProp",(e=>e.setOfRelativePropsByProp)),j.set("$definedProperties",(e=>e.definedProperties));const T=new Set(["$1","$2","$3","$4","$5","$6","$7","$8","$indexes","$component","$setOfImportProps","$setOfArrayProps","$setOfRelativePropsByProp","$definedProperties"]);class q extends Map{#t=!1;#s;constructor(e){super(),this.#s=e}set(e,t){this.#s.activeProperties?.has(e.path)&&(t=t?.[S]?t[F]:t,super.set(e,t))}deleteRelative(e){const t=this.#s.activeProperties;this.has(e)&&this.delete(e),t?.has(e.path)&&t.walkByParentPath(e.path,(e=>this.delete(e)))}}class H{component;prop;indexes;constructor(e,t){this.component=e,this.prop=t,this.indexes=e.stackIndexes.current?.slice(0)}get(e,t,s){return t===S||(t===F?e:Reflect.get(e,t,s))}set(e,t,s,i){return Reflect.set(e,t,s,i),"length"===t&&c.current.notify(this.component,this.prop,this.indexes??[]),!0}}const z=(e,t,s)=>(s=s?.[S]?s[F]:s)instanceof Array?new Proxy(s,new H(e,t)):s;class _{component;cache;importProps=[];setOfImportProps=new Set;arrayProps;setOfArrayProps;setOfRelativePropsByProp;definedProperties;constructor(e,t,s,i,o){this.component=e,this.#i(...t),this.cache=new q(e),this.arrayProps=s,this.setOfArrayProps=new Set(s),this.setOfRelativePropsByProp=i,this.definedProperties=o}#i(...e){this.importProps.push(...e),e.forEach((e=>this.setOfImportProps.add(e)))}$addImportProp(...e){e.pop(),e.pop(),Reflect.apply(this.#i,this,e)}$getValue(e,t,s){const i=this.cache,o=this.component;let n;return n=i.has(e)?z(o,e.name,i.get(e)):o.stackIndexes.push(e.indexes,(function(){const n=Reflect.get(t,e.name,s);return i.set(e,n),z(o,e.name,n)})),n}$setValue(e,t,s,i){const o=this.cache,n=this.component,r=this.$notify,a=this;n.stackIndexes.push(e.indexes,(function(){return Reflect.set(s,e.name,t,i),o.deleteRelative(e),Reflect.apply(r,a,[e.name,e.indexes??[],s,i]),!0}))}$asyncProc(...e){const t=e.pop(),[s,i=[]]=(e.pop(),e);c.current.asyncProc(s,t,i)}$notify(...e){e.pop(),e.pop();const[t,s=[]]=e;t.startsWith("__")||t.startsWith("$")||this.setOfImportProps.has(t)||c.current.notify(this.component,t,s)}async $init(e,t){"$relativeProps"in e&&Reflect.get(e,"$relativeProps",t).forEach((([e,t])=>{t.forEach((t=>{const s=this.setOfRelativePropsByProp.get(t).add(e)??new Set([e]);this.setOfRelativePropsByProp.set(t,s)}))})),"$onInit"in e&&await Reflect.apply(e.$onInit,t,[])}$deleteCache(e){const t=this.cache;for(const s of Array.from(e)){const e=l.getByPath(s);e&&t.deleteRelative(e)}}async $openDialog(...e){e.pop(),e.pop();const[t,s={}]=e,i=this.component;c.suspend(i);const o=te.tagName(t),n=document.createElement("template");n.innerHTML=`<${o} data-dialog></${o}>`;const r=document.importNode(n.content,!0),a=r.querySelector(o);try{return await new Promise((async(e,t)=>{a.setDialogInfo(i,e,t,s),document.body.appendChild(r),await a.initializePromise}))}catch(e){}finally{document.body.removeChild(a),c.resume()}}$closeDialog(e){this.component.closeDialog(e)}$cancelDialog(){this.component.cancelDialog()}$findNode(e,t){this.component.binder.findNode(e,t)}setOfNames;get(e,t,i){if(this.component.activeProperties?.has(t)){const s=this.component.activeProperties.get(t);return this.$getValue(s,e,i)}if(t in e){const s=Reflect.get(e,t,i);return z(this.component,t,s)}if("$"===t[0]){if(D.has(t))return(...s)=>Reflect.apply(this[t],this,[...s,e,i]);if(T.has(t)){const e=j.get(t);return e?e(this):s.isSymbol(t)?Reflect.get(this,t):this.component.stackIndexes.current[parseInt(t.slice(1))-1]}}}set(e,t,s,i){if(this.component.activeProperties.has(t)){const o=this.component.activeProperties.get(t);return this.$setValue(o,s,e,i),!0}return Reflect.set(e,t,s,i),!0}has(e,t,s){if("$"===t[0]){if(D.has(t))return!0;if(T.has(t))return!0}return t in e||Reflect.has(e,t,s)}}const W=Proxy,K=class{static create(e,t=e.viewModel){const{importProps:s,arrayProps:i,setOfRelativePropsByProp:o,definedProperties:n}=V.build(e);return new W(t,new _(e,s,i,o,n))}};class U{component;constructor(e){this.component=e}render(e=this.component,t=e.binder,s=e.template,i=e.shadowRoot??e){const o=document.importNode(s.content,!0);t.bind(o),i.appendChild(o)}}class G extends U{get css(){return"\n.bg {\n  position: fixed;\n  display: flex;\n  align-items: center;\n  justify-content: space-around;\n  background-color: rgba(0, 0, 0, 0.5);\n  left: 0;\n  top: 0;\n  height: 100vh;\n  width: 100vw;\n  z-index: fixed;\n  position: fixed;\n  position: 499;\n}\n.fg {\n  background-color: white;\n  border-radius: .375rem;\n  padding: 3rem;\n}\n    "}render(e=this.component,t=e.binder,s=e.template,i=e.shadowRoot??e){const o=document.importNode(s.content,!0);t.bind(o);const n=document.createElement("style");n.innerHTML=this.css,i.appendChild(n);const r=document.createElement("div");r.classList.add("bg");const a=document.createElement("div");a.classList.add("fg"),r.appendChild(a),a.appendChild(o),i.appendChild(r),r.addEventListener("click",(()=>e.cancelDialog())),a.addEventListener("click",(e=>e.stopPropagation()))}}class Z{stack=[];push(e,t){let s;this.stack.push(e);try{s=t()}finally{this.stack.pop()}return s}get current(){return this.stack[this.stack.length-1]}}class J{activeProperty;keys;compare(e){return this.activeProperty.compare(e.activeProperty)}}class Q{fixedActiveProperties=[];variableActivePropertiesByProp=new Map;activeProperties=[];activePropertyByPath=new Map;activePropertiesByName=new Map;activePropertiesByParentPath=new Map;definedProperties;definedPropertyByName;definedPropertiesOfList;lastProfiles=[];get(e){return this.activePropertyByPath.get(e)}has(e){return this.activePropertyByPath.has(e)}search(e,t){const s=this.activePropertiesByName.get(e)??[],i=t.toString(),o=0===t.length;return s.filter((e=>!!o||e.indexesStrings[t.length-1]===i))}walkByParentPath(e,t){const s=this.activePropertiesByParentPath,i=e=>{(s.get(e)??[]).forEach((e=>{t(e),i(e.path)}))};i(e)}constructor(e){this.definedProperties=e.filter((e=>!e.isGlobal&&!e.isContext)),this.definedPropertyByName=new Map(this.definedProperties.map((e=>[e.name,e]))),this.definedPropertiesOfList=this.definedProperties.filter((e=>"*"===e.last)).map((e=>this.definedPropertyByName.get(e.parentPath))),this.definedPropertiesByClosestListName=new Map,this.definedPropertyByName.forEach((e=>{this.definedPropertiesByClosestListName.has(e.closestListName)?this.definedPropertiesByClosestListName.get(e.closestListName).push(e):this.definedPropertiesByClosestListName.set(e.closestListName,[e])})),this.fixedActiveProperties=this.definedProperties.filter((e=>!e.isVariable)).map((e=>l.create(e.name,[])))}build(e){const t=[];this.definedPropertiesOfList.filter((e=>0===e.level)).forEach((s=>{const i=(s,o)=>{const n=l.create(s.name,o),r=e.$getValue(n),a=Object.keys(r);t.push(Object.assign(new J,{activeProperty:n,keys:a}));const c=this.definedPropertiesOfList.filter((e=>e.closestListName===s.name));for(const e of c)for(const t in a)i(e,o.concat(t))};i(s,[])})),t.sort(((e,t)=>e.compare(t)));let s=!1;const i=(e,t)=>this.definedPropertiesByClosestListName.get(e.activeProperty.name).map((i=>{const o=t.map((t=>l.create(i.name,e.activeProperty.indexes.concat(t))));this.variableActivePropertiesByProp.has(i)?this.variableActivePropertiesByProp.get(i).push(...o):this.variableActivePropertiesByProp.set(i,o),s=!0})),o=(e,t)=>this.definedPropertiesByClosestListName.get(e.activeProperty.name).map((e=>{this.variableActivePropertiesByProp.has(e)&&(null===t?this.variableActivePropertiesByProp.delete(e):this.variableActivePropertiesByProp.get(e).splice(t),s=!0)})),n=this.lastProfiles;let[r,a]=[0,0],[c,p]=[null,null];for(;null!=t[r]||null!=n[a];)if(c=t[r]??null,p=n[a]??null,null===c&&null!==p)o(p,null),a++;else if(null!==c&&null===p)i(c,c.keys),r++;else{const e=c.compare(p);if(e<0)i(c,c.keys),r++;else if(e>0)o(p,null),a++;else{if(c.keys.length===p.keys.length);else if(c.keys.length-p.keys.length>0){const e=c.keys.slice(p.keys.length,c.keys.length);i(c,e)}else o(p,c.keys.length);r++,a++}}if(this.lastProfiles=t,s||this.fixedActiveProperties.length>0&&0===this.activeProperties.length){const e=this.fixedActiveProperties.slice();this.variableActivePropertiesByProp.forEach((t=>{e.push(...t)}));const t=new Map(e.map((e=>[e.path,e]))),s=new Map;e.forEach((e=>s.has(e.name)?s.get(e.name).push(e):s.set(e.name,[e])));const i=new Map;e.forEach((e=>i.has(e.parentPath)?i.get(e.parentPath).push(e):i.set(e.parentPath,[e]))),this.activeProperties=e,this.activePropertyByPath=t,this.activePropertiesByName=s,this.activePropertiesByParentPath=i}}}class X extends HTMLElement{#o;#n;#r;#a;#c;#l;#p;#h;#d;template;viewModel;viewModelProxy;view;binder;stackIndexes;constructor(){super(),this.#c=!0,this.#n=new Promise(((e,t)=>{this.#r=e,this.#a=t}))}createView(){return"dialog"in this.dataset?new G(this):new U(this)}build(e){this.withoutShadowRoot||this.attachShadow({mode:"open"}),this.template=e.template,this.viewModel=Reflect.construct(e.ViewModel,[]),this.viewModelProxy=K.create(this),this.view=this.createView(),this.binder=new A(this),this.stackIndexes=new Z,this.activeProperties=new Q(this.viewModelProxy.$definedProperties),this.updateActiveProperty()}get parentComponent(){if(void 0===this.#o){let e=this;for(;e=e.parentNode,null!=e;){if(e instanceof ShadowRoot){e=e.host;break}if(e instanceof X)break}this.#o=e}return this.#o}set parentComponent(e){this.#o=e}get withoutShadowRoot(){return this.hasAttribute("without-shadowroot")}set withoutShadowRoot(e){e?this.setAttribute("without-shadowroot",""):this.removeAttribute("without-shadowroot")}get initializePromise(){return this.#n}get isInitializing(){return this.#c}setDialogInfo(e,t,s,i){this.#h=e,this.#l=t,this.#p=s,this.#d=i}get resolveForDialog(){return this.#l}get rejectForDialog(){return this.#p}get paramsForDialog(){return this.#d}get componentForDialog(){return this.#h}closeDialog(e){this.resolveForDialog(e)}cancelDialog(){this.rejectForDialog()}async dialogComponentInit(){c.current.asyncProc((async()=>{new x(this,this.componentForDialog).bind(this.paramsForDialog),await this.viewModelProxy.$init(),this.updateActiveProperty(),this.view.render()}),this,[])}async topComponentInit(){c.current.asyncProc((async()=>{const e=new x(this,null,[]);e.bind(),await this.viewModelProxy.$init(),this.updateActiveProperty(),A.rootBinder.add(e),this.view.render()}),this,[])}async defaultComponentInit(){c.current.asyncProc((async()=>{await this.parentComponent.initializePromise,await this.viewModelProxy.$init(),this.updateActiveProperty(),this.view.render()}),this,[])}async componentInit(){try{"dialog"in this.dataset?await this.dialogComponentInit():null==this.parentComponent?await this.topComponentInit():await this.defaultComponentInit()}finally{this.#c=!1,this.#r(!0)}}activeProperties;updateActiveProperty(){this.activeProperties.build(this.viewModelProxy)}async connectedCallback(){await this.componentInit()}disconnectedCallback(){}adoptedCallback(){}attributeChangedCallback(e,t,s){}}class Y extends Map{set(e,t){super.set(e.toUpperCase(),t),customElements.define(e,class extends ee{})}}class ee extends X{constructor(){super(),super.build(te.getComponentDataByTagName(this.tagName))}}class te{static#u;static get prefix(){return this.#u}static set prefix(e){this.#u=e}static tagName(e){return this.#u?`${this.#u}-${e}`:e}static#m=new Y;static getComponentDataByTagName(e){return this.#m.get(e)}static registComponentData(e,t){this.#m.set(s.toKebabCase(e),t)}}class se{html;css;template;ViewModel;static create(e){const t=Object.assign(new se,e);return t.template=t.template??this.createTemplate(this.mergeHtml(t.html,t.css)),t}static mergeHtml(e,t){return(t?`<style>${t}</style>`:"")+((e=e.replaceAll(/\{([^\}]+)\}/g,((e,t)=>`\x3c!--@@${t}--\x3e`)))??"")}static createTemplate(e){const t=document.createElement("template");return t.innerHTML=e,t}}window.redatax=class{static prefix=e=>(te.prefix=e,this);static components=e=>{for(const[t,s]of Object.entries(e)){const e=se.create(s);te.registComponentData(te.tagName(t),e)}return this};static globals=e=>(Object.assign(O,e),this)}})();